/*
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */

/*
 * JTarjetaSuperMaxi.java
 *
 * Created on 17-oct-2011, 13:22:19
 */
package com.comerzzia.jpos.gui.supermaxi;

import com.comerzzia.jpos.gui.IVista;
import com.comerzzia.jpos.gui.components.JVentanaDialogo;
import com.comerzzia.jpos.servicios.afiliacion.ITarjetaAfiliacion;
import com.comerzzia.jpos.servicios.afiliacion.validadores.TarjetaAfiliadoNotValidException;
import com.comerzzia.jpos.servicios.afiliacion.validadores.ValidadorTarjetasAfiliadosSevice;
import es.mpsistemas.util.log.Logger;
import javax.swing.JDialog;

/**
 *
 * @author Admin
 */
public class JTarjetaSuperMaxi extends JVentanaDialogo implements IVista {

    private static Logger log = Logger.getMLogger(JTarjetaSuperMaxi.class);
    private static final long serialVersionUID = 1L;

    private JDialog contenedor;
    private boolean exito;
    private ITarjetaAfiliacion tarjetaLeida;

    @Override
    public JDialog getContenedor() {
        return contenedor;
    }

    @Override
    public void setContenedor(JDialog contenedor) {
        this.contenedor = contenedor;
    }

    /** Creates new form JTarjetaSuperMaxi */
    public JTarjetaSuperMaxi() {
        super();
        exito = false;
        initComponents();

    }

    /** This method is called from within the constructor to
     * initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is
     * always regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        lb_n_tarjeta_superMaxi = new javax.swing.JLabel();
        t_n_tarjeta_superMaxi = new com.comerzzia.jpos.gui.components.form.JTextFieldForm();
        lb_deslice = new javax.swing.JLabel();
        lb_error = new javax.swing.JLabel();

        lb_n_tarjeta_superMaxi.setFont(lb_n_tarjeta_superMaxi.getFont().deriveFont(lb_n_tarjeta_superMaxi.getFont().getStyle() | java.awt.Font.BOLD, lb_n_tarjeta_superMaxi.getFont().getSize()+1));
        lb_n_tarjeta_superMaxi.setText("N° de tarjeta de afiliación o Nº de cédula:");

        t_n_tarjeta_superMaxi.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                t_n_tarjeta_superMaxiActionPerformed(evt);
            }
        });
        t_n_tarjeta_superMaxi.addKeyListener(new java.awt.event.KeyAdapter() {
            public void keyTyped(java.awt.event.KeyEvent evt) {
                t_n_tarjeta_superMaxiKeyTyped(evt);
            }
        });

        lb_deslice.setHorizontalAlignment(javax.swing.SwingConstants.CENTER);
        lb_deslice.setText("Deslice la tarjeta o introduzca la cédula");

        lb_error.setForeground(new java.awt.Color(204, 0, 0));
        lb_error.setHorizontalAlignment(javax.swing.SwingConstants.CENTER);

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(this);
        this.setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(layout.createSequentialGroup()
                        .addGap(26, 26, 26)
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING, false)
                            .addComponent(lb_deslice, javax.swing.GroupLayout.Alignment.TRAILING, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                            .addComponent(t_n_tarjeta_superMaxi, javax.swing.GroupLayout.Alignment.TRAILING, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                            .addComponent(lb_n_tarjeta_superMaxi, javax.swing.GroupLayout.PREFERRED_SIZE, 355, javax.swing.GroupLayout.PREFERRED_SIZE)))
                    .addGroup(layout.createSequentialGroup()
                        .addContainerGap()
                        .addComponent(lb_error, javax.swing.GroupLayout.DEFAULT_SIZE, 453, Short.MAX_VALUE)))
                .addContainerGap())
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addComponent(lb_n_tarjeta_superMaxi)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addComponent(lb_deslice)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(t_n_tarjeta_superMaxi, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(lb_error, javax.swing.GroupLayout.DEFAULT_SIZE, 47, Short.MAX_VALUE)
                .addContainerGap())
        );
    }// </editor-fold>//GEN-END:initComponents

private void t_n_tarjeta_superMaxiActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_t_n_tarjeta_superMaxiActionPerformed
}//GEN-LAST:event_t_n_tarjeta_superMaxiActionPerformed

private void t_n_tarjeta_superMaxiKeyTyped(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_t_n_tarjeta_superMaxiKeyTyped
    if (t_n_tarjeta_superMaxi.getText().isEmpty()) {
        return;
    }
    ITarjetaAfiliacion tarjetaAfiliacion = null;
    try {
        if (evt.getKeyChar() == '\n') {
            String numTarjeta = t_n_tarjeta_superMaxi.getText();
            if(numTarjeta.indexOf("%") == 0){
                numTarjeta = numTarjeta.substring(1);
            }
            if (numTarjeta.contains("B") || numTarjeta.contains("000")){
                tarjetaAfiliacion = ValidadorTarjetasAfiliadosSevice.getInstance().validarBanda(numTarjeta);
            }
            else{
                tarjetaAfiliacion = ValidadorTarjetasAfiliadosSevice.getInstance().validarNumTarjeta(numTarjeta);
            }
        }
    }
    catch(TarjetaAfiliadoNotValidException e){
        t_n_tarjeta_superMaxi.setText("");
        log.debug(e.getMessage());
        setTarjetaLeida(null);
        lb_error.setText(e.getMessage());
    }
    if (tarjetaAfiliacion != null) {
        setTarjetaLeida(tarjetaAfiliacion);
        t_n_tarjeta_superMaxi.setText("");
        lb_error.setText("");
        setExito(true);
        contenedor.setVisible(false);
    }

}//GEN-LAST:event_t_n_tarjeta_superMaxiKeyTyped
    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JLabel lb_deslice;
    private javax.swing.JLabel lb_error;
    private javax.swing.JLabel lb_n_tarjeta_superMaxi;
    private com.comerzzia.jpos.gui.components.form.JTextFieldForm t_n_tarjeta_superMaxi;
    // End of variables declaration//GEN-END:variables

    @Override
    public void iniciaVista() {
        setTarjetaLeida(null);
        t_n_tarjeta_superMaxi.setText("");
        lb_error.setText("");
        t_n_tarjeta_superMaxi.requestFocus();
    }

    @Override
    public void iniciaFoco() {
        t_n_tarjeta_superMaxi.requestFocus();
    }

    @Override
    public void accionAceptar() {
        // Se esta aceptando de otra forma '\n' en el campo
    }

    @Override
    public void limpiarFormulario() {
        setTarjetaLeida(null);
        t_n_tarjeta_superMaxi.setText("");
        lb_error.setText("");
    }

    public void accionCancelar() {
        setTarjetaLeida(null);
        limpiarFormulario();
        exito = false;
        this.getContenedor().setVisible(false);
    }

    /**
     * @return the exito
     */
    public boolean isExito() {
        return exito;
    }

    /**
     * @param exito the exito to set
     */
    public void setExito(boolean exito) {
        this.exito = exito;
    }

    @Override
    public void accionLeerTarjetaVD() {
    }

    public ITarjetaAfiliacion getTarjetaLeida() {
        return tarjetaLeida;
    }

    public void setTarjetaLeida(ITarjetaAfiliacion tarjetaLeida) {
        this.tarjetaLeida = tarjetaLeida;
    }
}
